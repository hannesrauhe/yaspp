# Copilot Instructions for pad2gh

## Purpose

The `pad2gh` module is a Go-based tool that extracts podcast episode metadata from HedgeDoc collaborative pad entries and converts them into structured YAML format for the YASPP publishing system.

## Core Functionality

This tool automates the process of converting collaboratively-written episode notes into podcast episode data by:

1. **Fetching pad content** from HedgeDoc URLs (`https://pad.ccc-p.org/`)
2. **Parsing markdown sections** with specific headers (## Summary, ## Shownotes, etc.)
3. **Extracting structured data** (titles, timestamps, music links)
4. **Generating YAML output** compatible with the main publishing system
5. **Creating PR comments** with validation errors or warnings

## Key Functions & Data Flow

### Main Processing Pipeline (`main()`)
1. Parse command-line flags (`-l`, `-o`, `-c`, `-v`)
2. Get pad URL (from flag or auto-detect from Radio page)
3. Fetch and parse pad content by markdown sections
4. Extract date from pad URL (format: `YYYY-MM-DD_`)
5. Build episode metadata from parsed sections
6. Write YAML to content file and comments to PR file

### Section Parsing (`getMarkdownContentBySection()`)
- Splits HedgeDoc markdown by `##` headers
- Groups content lines under section names (lowercased, trimmed)
- Returns `map[string][]string` of section content

### Expected Pad Structure
The tool expects HedgeDoc pads with these markdown sections:

```markdown
## Summary
Brief episode description...

## Shownotes
- Detailed show notes
- Links and references
- Topics discussed

## Chapters  
00:00:00 Intro
00:05:30 Main topic discussion
00:45:00 Outro

## Mukke
- Artist - Song Title <https://freemusicarchive.org/...>
- Another Artist - Another Song <https://example.com/...>
```

## Data Structures

### `CiREntry` - Main Episode Data
```go
type CiREntry struct {
    UUID            string       `yaml:"uuid"`            // Generated: nt-YYYY-MM-DD
    Title           string       `yaml:"title"`           // Generated: CiR am DD.MM.YYYY  
    Subtitle        string       `yaml:"subtitle"`        // Static: "Der Chaostreff im Freien Radio Potsdam"
    Summary         string       `yaml:"summary"`         // From "summary" section
    PublicationDate string       `yaml:"publicationDate"` // Generated: YYYY-MM-DDTHH:MM:SS+02:00
    Audio           CiRaudio     `yaml:"audio"`           // Generated audio URL
    Chapters        []CiRChapter `yaml:"chapters"`        // From "chapters" section
    LongSummaryMD   string       `yaml:"long_summary_md"` // From "shownotes" section
    padURL          string       // Internal: source pad URL
    prComments      []string     // Internal: validation warnings
}
```

### `CiRaudio` - Audio File Metadata
```go
type CiRaudio struct {
    Url      string // Format: $media_base_url/YYYY_MM_DD-chaos-im-radio.mp3
    MimeType string // Always: "audio/mp3"
}
```

### `CiRChapter` - Chapter/Timestamp Data  
```go
type CiRChapter struct {
    Start string // Format: HH:MM:SS from chapter lines
    Title string // Extracted from chapter lines after timestamp
}
```

## URL and Date Processing

### Pad URL Requirements
- Must start with `https://pad.ccc-p.org/`
- Must contain date in format `YYYY-MM-DD_` (underscore-separated)
- Example: `https://pad.ccc-p.org/Radio_2024-01-15_episode-notes`

### Date Extraction Logic
```go
entryDate := strings.Split(entry.padURL, "_")[1]  // Gets "2024-01-15"
year := entryDate[0:4]   // "2024"
month := entryDate[5:7]  // "01" 
day := entryDate[8:10]   // "15"
```

### Generated Fields
- **UUID**: `fmt.Sprintf("nt-%s-%s-%s", year, month, day)`
- **Title**: `fmt.Sprintf("CiR am %s.%s.%s", day, month, year)`
- **Audio URL**: `fmt.Sprintf("$media_base_url/%s_%s_%s-chaos-im-radio.mp3", year, month, day)`
- **Publication Date**: `fmt.Sprintf("%s-%s-%sT00:00:00+02:00", year, month, day)`

## Error Handling & Validation

### Fatal Errors (program exits)
- Invalid or missing pad URL
- Missing "summary" section in pad
- Missing "shownotes" or "long summary" section
- Invalid date format in pad URL
- File I/O errors when writing output

### Non-Fatal Warnings (added to `prComments`)
- Missing "chapters" section
- Missing "mukke" section  
- Malformed chapter lines (not enough parts)
- Invalid music links (no URL found)
- Failed music title extraction from FMA

### Logging Patterns
```go
logger := logrus.StandardLogger()
logger.SetLevel(logrus.DebugLevel)  // if -v flag
logger.Debugf("pad url: %s\n", entry.padURL)
logger.Fatalf("no Summary Section in Pad")
logger.Warn(entry.prComments)
```

## Music Link Processing

### FMA (Free Music Archive) Integration
- Extracts URLs from "mukke" section lines
- Attempts to fetch song titles from FMA API
- Falls back to raw URL if title extraction fails
- Formats as markdown links in long summary

### Link Processing Functions
```go
findFirstLink(line string) string          // Extracts first URL from text
getTitleFromFMA(fmaURL string) (string, error)  // Gets song title from FMA
```

## Command-Line Interface

### Flags
- `-l <url>` - Specify pad URL (otherwise auto-detects from Radio page)
- `-o <file>` - Output YAML file path (default: `../content.yaml`)
- `-c <file>` - Comments file path (default: `../comments.md`)  
- `-v` - Verbose logging (debug level)

### Usage Examples
```bash
# Auto-detect latest pad from Radio page
go run main.go -o ../content.yaml -c ../comments.md

# Parse specific pad URL
go run main.go -l https://pad.ccc-p.org/Radio_2024-01-15_episode -o ../content.yaml

# Verbose output to stdout
go run main.go -v
```

## File Output

### YAML Output (appended to content file)
```yaml
---
uuid: nt-2024-01-15
title: CiR am 15.01.2024
subtitle: Der Chaostreff im Freien Radio Potsdam
summary: Episode summary from pad...
publicationDate: "2024-01-15T00:00:00+02:00"
audio:
  url: $media_base_url/2024_01_15-chaos-im-radio.mp3
  mimeType: audio/mp3
chapters:
  - start: "00:00:00"
    title: "Intro"
long_summary_md: "**Shownotes:**\nDetailed notes..."
```

### Comments Output (for PR body)
- Starts with episode summary
- Appends validation errors/warnings under "## Errors" heading
- Used by GitHub Actions workflow for PR descriptions

## Development Guidelines

### When Adding New Pad Sections:
1. Add section name to expected sections in `getMarkdownContentBySection()`
2. Handle the new section data in main processing logic
3. Update struct fields if needed (with yaml tags)
4. Add appropriate error handling/validation

### When Modifying Date/URL Processing:
- Ensure backward compatibility with existing pad URL formats
- Test with various date formats and edge cases
- Update validation error messages to be helpful

### When Changing Output Format:
- Verify compatibility with `yaspp.py` YAML parser
- Test with existing `content.yaml` structure
- Update corresponding Python code if needed

### Testing Considerations:
- Test with real HedgeDoc pads from `https://pad.ccc-p.org/`
- Verify network error handling for unreachable pads
- Test edge cases: missing sections, malformed timestamps, invalid URLs
- Validate YAML output parses correctly in Python